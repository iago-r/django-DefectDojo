{% load i18n %}
{% load static %}

{% block add_css %}
  <link rel="stylesheet" href="{% static "dojo/css/cve_metadata.css" %}">
{% endblock %}

<div class="panel panel-default">
  <div class="panel-heading">
    <h4>
      {% trans "Metadata" %}
      <span class="pull-right">
        <a data-toggle="collapse" href="#test_panel">
          <i class="glyphicon glyphicon-chevron-{% if cves_metadata %}up{%else%}down{%endif%}"></i>
        </a>
      </span>
    </h4>
  </div>
  <div id="test_panel" class="panel-body finding-description collapse {% if cves_metadata %}in{% endif %}">
    {% if cves_metadata %}
      <div class="cve_dashboard">
          {% for cve in cves_metadata %}
            {% include "dojo/snippets/card.html" with cve=cve %}
          {% endfor %}
      </div>
    {%else%} 
      {% trans "No CVEs for this finding" %}
    {%endif%}
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Find all CVE cards within the dashboard
  const cveCards = Array.from(document.querySelectorAll('.cve_dashboard .cve_card'));
  
  // If we have more than 8 cards, implement pagination
  if (cveCards.length > 8) {
    // Add appearing class to all cards (for animation)
    cveCards.forEach(card => {
      card.classList.add('appearing');
    });
    
    // Function to animate cards appearing
    function animateCards(startIdx, endIdx) {
      let delay = 0;
      for (let i = startIdx; i < endIdx; i++) {
        if (i < cveCards.length) {
          const card = cveCards[i];
          // Show the card
          card.style.display = '';
          
          // Animate after a small delay for each card
          setTimeout(() => {
            card.classList.remove('appearing');
            card.classList.add('appeared');
          }, delay);
          
          delay += 50; // Stagger the animations
        }
      }
    }
    
    // Initially hide all cards beyond the first 8
    for (let i = 8; i < cveCards.length; i++) {
      cveCards[i].style.display = 'none';
    }
    
    // Animate initial cards
    animateCards(0, 8);
    
    // Set currentlyVisible to track how many cards are shown
    let currentlyVisible = 8;
    const remaining = cveCards.length - currentlyVisible;
    
    // Create and add a "Load More" button
    const loadMoreBtn = document.createElement('button');
    loadMoreBtn.className = 'load-more-cves';
    
    // Add counter span to show remaining cards
    const textSpan = document.createElement('span');
    textSpan.textContent = 'Load More CVEs';
    
    const counterSpan = document.createElement('span');
    counterSpan.className = 'counter';
    counterSpan.textContent = remaining;
    
    loadMoreBtn.appendChild(textSpan);
    loadMoreBtn.appendChild(counterSpan);
    
    loadMoreBtn.addEventListener('click', function() {
      this.classList.add('loading');
      
      this.disabled = true;
      
      setTimeout(() => {
        const nextBatch = Math.min(currentlyVisible + 8, cveCards.length);
        

        animateCards(currentlyVisible, nextBatch);
        
        currentlyVisible = nextBatch;
        

        const newRemaining = cveCards.length - currentlyVisible;
        counterSpan.textContent = newRemaining;
        
        if (currentlyVisible >= cveCards.length) {
          this.style.display = 'none';
        } else {
          this.classList.remove('loading');
          this.disabled = false;
        }
      }, 500);
    });
    
    const cveDashboard = document.querySelector('.cve_dashboard');
    cveDashboard.parentNode.insertBefore(loadMoreBtn, cveDashboard.nextSibling);
  }
});
</script>